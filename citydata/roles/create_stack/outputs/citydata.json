{
    "Description": "Data Exchange",
    "AWSTemplateFormatVersion": "2010-09-09",
    "Outputs" : {
        "PrvIp" : {
          "Value" : { "Fn::GetAtt" : [ "DataExchange", "PrivateIp" ]},
          "Description" : "DataExchange server's Private IP Address"
        }
    },
    "Resources": {
        "DataExchange": {
            "Type": "AWS::EC2::Instance",
            "Properties": {
                "DisableApiTermination": "false",
                "InstanceInitiatedShutdownBehavior": "stop",
                "ImageId": "ami-0ad16744583f21877",
                "InstanceType": "t2.xlarge",
                "KeyName": "KERData",
                "Monitoring": "false",
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "DataExchange-test"
                    },
                    {
                        "Key": "Owner",
                        "Value": "Jonathan Doig"
                    }
                ],
                "Volumes": [
                  {
                    "Device": "/dev/xvdb",
                    "VolumeId": {
                      "Ref": "volData"
                    }
                  },
                  {
                    "Device": "/dev/xvdf",
                    "VolumeId": {
                      "Ref": "volBackup"
                    }
                  },
                  {
                    "Device": "/dev/xvdg",
                    "VolumeId": {
                      "Ref": "volGWC"
                    }
                  },
                  {
                    "Device": "/dev/xvdh",
                    "VolumeId": {
                      "Ref": "volDocker"
                    }
                  }
                ],
                "NetworkInterfaces": [
                    {
                        "DeleteOnTermination": "true",
                        "Description": "Primary network interface",
                        "DeviceIndex": 0,
                        "SubnetId": "subnet-75cfd012",
                        
                        "GroupSet": [
                            {
                                "Ref": "SGDataExchange"
                            }
                        ]
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "8f77b450-eebc-4160-8475-f1fc2e7713db"
                }
            }
        },
        "IPAssoc": {
    "Type": "AWS::EC2::EIPAssociation",
    "Properties": {
        "EIP": "52.53.42.21",
        "InstanceId": { "Ref": "DataExchange"}
      }
},

        "volData": {
            "Type": "AWS::EC2::Volume",
            "Properties": {
                "AvailabilityZone": "us-west-1a",
                "Size": "100",
                "VolumeType": "gp2"
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "1d252d89-effb-4317-b886-6ca4d302f6c0"
                }
            }
        },
        "volBackup": {
            "Type": "AWS::EC2::Volume",
            "Properties": {
                "AvailabilityZone": "us-west-1a",
                "Size": "200",
                "VolumeType": "gp2"
            },
        },
        "volGWC": {
            "Type": "AWS::EC2::Volume",
            "Properties": {
                "AvailabilityZone": "us-west-1a",
                "Size": "300",
                "VolumeType": "gp2"
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "1d252d89-effb-4317-b886-6ca4d302f6c0"
                }
            }
        },
        "volDocker": {
            "Type": "AWS::EC2::Volume",
            "Properties": {
                "AvailabilityZone": "us-west-1a",
                "Size": "30",
                "VolumeType": "gp2"
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "1d252d89-effb-4317-b886-6ca4d302f6c0"
                }
            }
        },
        "SGDataExchange": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupName": "DataExchange-test",
                "GroupDescription": "DataExchange SG",
                "VpcId": "vpc-cbfbd7ac",
                "Tags": [
                    {
                        "Key": "Owner",
                        "Value": "Jonathan Doig"
                    },
                    {
                        "Key": "Name",
                        "Value": "DataExchange-test"
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "a1362cf7-a3c7-4ba4-a9d5-c180237f7be7"
                }
            }
        },
        "ingress1": {
            "Type": "AWS::EC2::SecurityGroupIngress",
            "Properties": {
                "GroupId": {
                    "Ref": "SGDataExchange"
                },
                "Description": "HTTP from public",
                "IpProtocol": "tcp",
                "FromPort": "80",
                "ToPort": "80",
                "CidrIp": "0.0.0.0/0"
            }
        },
        "ingress2": {
            "Type": "AWS::EC2::SecurityGroupIngress",
            "Properties": {
                "GroupId": {
                    "Ref": "SGDataExchange"
                },
                "Description": "SSH from Ansible control",
                "IpProtocol": "tcp",
                "FromPort": "22",
                "ToPort": "22",
                "CidrIp": "172.31.21.133/32"
            }
        },
        "ingress3": {
            "Type": "AWS::EC2::SecurityGroupIngress",
            "Properties": {
                "GroupId": {
                    "Ref": "SGDataExchange"
                },
                "Description": "SSH from devops home",
                "IpProtocol": "tcp",
                "FromPort": "22",
                "ToPort": "22",
                "CidrIp": "211.30.23.60/32"
            }
        },
        "ingress4": {
            "Type": "AWS::EC2::SecurityGroupIngress",
            "Properties": {
                "GroupId": {
                    "Ref": "SGDataExchange"
                },
                "Description": "SSH from devops work",
                "IpProtocol": "tcp",
                "FromPort": "22",
                "ToPort": "22",
                "CidrIp": "149.171.161.0/24"
            }
        },
        "ingress5": {
            "Type": "AWS::EC2::SecurityGroupIngress",
            "Properties": {
                "GroupId": {
                    "Ref": "SGDataExchange"
                },
                "Description": "SSH from devops work 2",
                "IpProtocol": "tcp",
                "FromPort": "22",
                "ToPort": "22",
                "CidrIp": "129.94.8.40/32"
            }
        },
        "ingress6": {
            "Type": "AWS::EC2::SecurityGroupIngress",
            "Properties": {
                "GroupId": {
                    "Ref": "SGDataExchange"
                },
                "Description": "SSH from devops VPN",
                "IpProtocol": "tcp",
                "FromPort": "22",
                "ToPort": "22",
                "CidrIp": "172.26.208.113/32"
            }
        },
        "ingress7": {
    "Type": "AWS::EC2::SecurityGroupIngress",
    "Properties": {
        "GroupId": {
            "Ref": "SGDataExchange"
        },
        "Description": "Push data from source",
        "IpProtocol": "tcp",
        "FromPort": "22",
        "ToPort": "22",
        "CidrIp": "172.31.20.215/32"
    }
},

        "egress1": {
            "Type": "AWS::EC2::SecurityGroupEgress",
            "Properties": {
                "GroupId": {
                    "Ref": "SGDataExchange"
                },
                "Description": "Allow all out",
                "IpProtocol": "-1",
                "FromPort": "-1",
                "ToPort": "-1",
                "CidrIp": "0.0.0.0/0"
            }
        },
    }
}
